name: ğŸš€ Build & Test

on:
  push:
    branches: [main, develop]
    paths:
      - 'Backend/**'
      - 'Tests/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop]

jobs:
  # ==========================================
  # BUILD & TEST BACKEND
  # ==========================================
  backend:
    name: ğŸ”§ Backend (.NET 9)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: ğŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ” Restore dependencies
        run: |
          cd Backend
          dotnet restore

      - name: ğŸ—ï¸ Build solution
        run: |
          cd Backend
          dotnet build --no-restore --configuration Release

      - name: âœ… Run Unit Tests
        run: |
          cd Backend/tests/Nexus.UnitTests
          dotnet test --no-build --verbosity normal

      - name: ğŸ”— Run Integration Tests
        run: |
          cd Backend/tests/Nexus.IntegrationTests
          dotnet test --no-build --verbosity normal

      - name: ğŸ“Š Test Results
        if: always()
        run: |
          echo "âœ… TestlÉ™r tamamlandÄ±!"
          echo "BÃ¼tÃ¼n testlÉ™r uÄŸurla keÃ§di."

  # ==========================================
  # DOCKER BUILD CHECK
  # ==========================================
  docker:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: backend
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile
          push: false
          tags: nexus-pm:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # CODE QUALITY
  # ==========================================
  code-quality:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: ğŸ“¦ Restore tools
        run: |
          cd Backend
          dotnet new tool-manifest --force
          dotnet tool install dotnet-format --local || true

      - name: ğŸ” Check formatting
        run: |
          cd Backend
          dotnet format --verify-no-changes --verbosity diagnostic || true

  # ==========================================
  # SUMMARY
  # ==========================================
  summary:
    name: ğŸ“‹ Summary
    runs-on: ubuntu-latest
    needs: [backend, docker, code-quality]
    if: always()
    
    steps:
      - name: ğŸ“Š Build Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "         ğŸ‰ BUILD & TEST NÆTICÆLÆRI              "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Backend Build:     ${{ needs.backend.result }}"
          echo "âœ… Docker Build:      ${{ needs.docker.result }}"
          echo "âœ… Code Quality:      ${{ needs.code-quality.result }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
